{{ 
  if or (eq .chezmoi.os "darwin") 
    (and (eq .chezmoi.os "linux") 
      (or (eq .chezmoi.arch "amd64") (eq .chezmoi.arch "arm64")))
    -}}
#!/bin/bash

if ! command -v brew >/dev/null 2>&1; then
  sudo echo "Installing Homebrew, requires sudo privilege..."
  curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh | NONINTERACTIVE=1 bash
fi

# Ensure Homebrew is in PATH for this session
if [[ -f "/opt/homebrew/bin/brew" ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -f "/usr/local/bin/brew" ]]; then
  eval "$(/usr/local/bin/brew shellenv)"
fi

# Verify brew is now available
if ! command -v brew >/dev/null 2>&1; then
  echo "Error: brew command not found after installation attempt"
  exit 1
fi

echo "Running brew bundle..."
brew bundle --upgrade --file=/dev/stdin <<EOF

brew "git"
brew "htop"
brew "sl"
brew "tmux"
brew "vim"
brew "neovim"
brew "tree"
brew "grep"
brew "ripgrep"
brew "gawk"
brew "gnu-sed"
brew "zsh"
brew "rg"
brew "fd"
brew "jq"
brew "fzf"
brew "fpp"
brew "fnm"
brew "ghq"
brew "eza"
brew "sevenzip"
brew "poppler"
brew "ffmpeg"
brew "ghostscript"
brew "imagemagick"
brew "yazi"
brew "python"
brew "awscli"
brew "zoxide"
brew "pipx"
brew "ruby"
brew "rbenv"
brew "ruby-build"
brew "chezmoi"
brew "yt-dlp"
brew "sponge"
brew "aerc"
brew "neomutt"
brew "irssi"
brew "age"
brew "rage"
brew "asdf"

# casks 
tap "nikitabobko/tap" # aerospace tap
cask "ghostty"
cask "iterm2"
cask "1password"
cask "1password-cli"
cask "karabiner-elements"
cask "bitwarden"
cask "aerospace"
cask "protonvpn"
cask "proton-mail"
cask "proton-mail-bridge"
cask "arc"
cask "google-chrome"
cask "firefox@nightly"
cask "vscodium"
cask "xld"
cask "vlc"
cask "audacity"
cask "gimp"
cask "tidal"
cask "spotify"
cask "little-snitch"
cask "caffeine"
cask "hammerspoon"
cask "transmission"
cask "obsidian"

{{ if contains .chezmoi.username "ooi" }}
# Additional work-related packages 

# Casks
cask "slack"
cask "microsoft-teams"
cask "microsoft-outlook" 
cask "zoom"
cask "amazon-workspaces"
{{- end }}

EOF
{{ end -}}
